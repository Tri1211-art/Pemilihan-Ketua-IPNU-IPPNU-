<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Voting MTs Unggulan Minhajut Tholabah</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f4f7f6; }
        .navbar { background-color: #008148 !important; } /* Hijau Khas IPNU */
        .card { border: none; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .hidden { display: none; }
        .candidate-card { transition: 0.3s; cursor: pointer; border: 2px solid transparent; }
        .candidate-card:hover { transform: translateY(-5px); border-color: #008148; }
        .candidate-img { width: 100%; height: 250px; object-fit: cover; border-radius: 10px; }
        .btn-ipnu { background-color: #008148; color: white; border-radius: 25px; }
        .btn-ipnu:hover { background-color: #006b3c; color: white; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark shadow-sm mb-4">
    <div class="container text-center">
        <span class="navbar-brand mx-auto fw-bold">E-VOTING IPNU IPPNU MTs MINTHOL</span>
    </div>
</nav>

<div class="container">
    
    <div id="loginSection" class="row justify-content-center mt-5">
        <div class="col-md-4">
            <div class="card p-4">
                <div class="text-center mb-4">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/a/a2/Logo_IPNU.png" alt="Logo" width="70">
                    <h5 class="mt-3 fw-bold">Silahkan Masuk</h5>
                </div>
                <div class="mb-3">
                    <label class="form-label">Username (NIS)</label>
                    <input type="text" id="username" class="form-control" placeholder="Masukkan NIS">
                </div>
                <div class="mb-3">
                    <label class="form-label">Password</label>
                    <input type="password" id="password" class="form-control" placeholder="Masukkan Password">
                </div>
                <button onclick="login()" class="btn btn-ipnu w-100 py-2">Masuk</button>
            </div>
        </div>
    </div>

   <div id="loginSection" class="row justify-content-center mt-5">
    <div class="col-md-4">
        <div class="card p-4 shadow-lg border-0">
            <div class="text-center mb-4">
                <img src="https://upload.wikimedia.org/wikipedia/commons/a/a2/Logo_IPNU.png" width="70" alt="Logo">
                <h4 class="mt-3 fw-bold">E-VOTING MINTHOL</h4>
                <p class="text-muted small">Masukkan Akun Pemilih / Admin</p>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Username (NIS)</label>
                <input type="text" id="username" class="form-control" placeholder="Contoh: 2024001">
            </div>
            <div class="mb-3">
                <label class="form-label">Password</label>
                <input type="password" id="password" class="form-control" placeholder="Masukkan password">
            </div>
            <button onclick="auth()" class="btn btn-success w-100 py-2 fw-bold" style="background-color: #008148;">MASUK</button>
            
            <div id="loginError" class="text-danger small mt-2 text-center" style="display:none;">
                Username atau Password salah!
            </div>
        </div>
    </div>
</div>

<script>
    // DATA LOGIN ADMIN
    const ADMIN_CREDENTIALS = {
        user: "adminminthol",
        pass: "panitia2024"
    };

    // FUNGSI AUTHENTICATION
    function auth() {
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        const errorMsg = document.getElementById('loginError');

        // 1. Cek Login Admin
        if (u === ADMIN_CREDENTIALS.user && p === ADMIN_CREDENTIALS.pass) {
            showSection('adminSection');
            refreshChart(); // Memuat diagram batang
            return;
        }

        // 2. Cek Login Siswa (Logika Sederhana)
        // Idealnya ini divalidasi ke database Google Sheets
        // Namun untuk tahap awal, kita buat validasi NIS minimal 5 angka
        if (u.length >= 5 && p === "12345") {
            localStorage.setItem("voterID", u);
            showSection('voteSection');
            errorMsg.style.display = 'none';
        } else {
            errorMsg.style.display = 'block';
        }
    }

    // Fungsi pindah halaman
    function showSection(id) {
        document.getElementById('loginSection').classList.add('hidden');
        document.getElementById('voteSection').classList.add('hidden');
        document.getElementById('adminSection').classList.add('hidden');
        document.getElementById(id).classList.remove('hidden');
    }

    function logout() {
        localStorage.clear();
        location.reload();
    }
</script>

    <div id="adminSection" class="hidden">
        <div class="card p-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="fw-bold">Rekapitulasi Suara Terkini</h4>
                <button onclick="loadStats()" class="btn btn-sm btn-outline-success">Refresh Data</button>
            </div>
            <div style="position: relative; height:350px;">
                <canvas id="voteChart"></canvas>
            </div>
            <hr>
            <div class="text-center mt-3">
                <button onclick="logout()" class="btn btn-secondary btn-sm">Keluar Admin</button>
            </div>
        </div>
    </div>

</div>

<script>
    // --- KONFIGURASI ---
    const APP_URL = "https://script.google.com/macros/s/AKfycbwD_vC-z9sajRUCk9vwHFDpzDHRULZKHEsRy5PmIUYSHrooR_71Kh3OHGZFA9mGMjAZiw/exec"; 
    const ADMIN_USER = "admin";
    const ADMIN_PASS = "adminminthol";

    // Fungsi Login
    function login() {
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;

        if (u === ADMIN_USER && p === ADMIN_PASS) {
            showSection('adminSection');
            loadStats();
        } else if (u !== "" && p !== "") {
            localStorage.setItem("voter", u);
            showSection('voteSection');
        } else {
            alert("Username dan Password harus diisi!");
        }
    }

    // Ganti Halaman
    function showSection(id) {
        document.getElementById('loginSection').classList.add('hidden');
        document.getElementById('voteSection').classList.add('hidden');
        document.getElementById('adminSection').classList.add('hidden');
        document.getElementById(id).classList.remove('hidden');
    }

    // Kirim Suara ke Google Sheets
    async function submitVote(pilihan) {
        if (!confirm("Konfirmasi pilihan: " + pilihan + "?")) return;

        const voter = localStorage.getItem("voter");
        try {
            await fetch(APP_URL, {
                method: 'POST',
                body: JSON.stringify({ user: voter, kandidat: pilihan })
            });
            alert("Suara Anda berhasil dikirim!");
            logout();
        } catch (err) {
            alert("Gagal terhubung ke database!");
        }
    }

    // Ambil Data Suara & Tampilkan Diagram
    async function loadStats() {
        try {
            const res = await fetch(APP_URL);
            const data = await res.json();
            
            const ctx = document.getElementById('voteChart').getContext('2d');
            
            if (window.chartObj) window.chartObj.destroy();
            
            window.chartObj = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        label: 'Perolehan Suara',
                        data: Object.values(data),
                        backgroundColor: ['#008148', '#2ecc71', '#f1c40f'],
                        borderRadius: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                }
            });
        } catch (err) {
            console.error("Gagal memuat statistik");
        }
    }

    function logout() {
        localStorage.clear();
        location.reload();
    }
</script>

</body>
</html>
